# 数据库详细设计文档

## 数据库选型

### SQLite选择理由
- **轻量级**：无需独立的数据库服务器进程
- **零配置**：无需复杂的安装和配置
- **文件存储**：整个数据库存储在单个文件中，便于备份
- **事务支持**：支持ACID事务
- **性能足够**：对于小型应用，性能完全满足需求

### 数据库配置
```javascript
// 数据库文件路径
const DATABASE_PATH = './database/knowledge_base.db';

// 连接配置
const dbConfig = {
  filename: DATABASE_PATH,
  driver: sqlite3.Database,
  mode: sqlite3.OPEN_READWRITE | sqlite3.OPEN_CREATE
};
```

## 数据库表设计

### 1. 用户表（users）

**表结构**：
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) DEFAULT 'user',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明**：
| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 用户ID |
| username | VARCHAR(50) | NOT NULL, UNIQUE | 用户名 |
| email | VARCHAR(100) | NOT NULL, UNIQUE | 邮箱地址 |
| password_hash | VARCHAR(255) | NOT NULL | 加密后的密码 |
| role | VARCHAR(20) | DEFAULT 'user' | 用户角色（admin/user） |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
```sql
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_role ON users(role);
```

### 2. 文档表（documents）

**表结构**：
```sql
CREATE TABLE documents (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INTEGER NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    upload_user_id INTEGER NOT NULL,
    is_public BOOLEAN DEFAULT 0,
    tags TEXT,
    download_count INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (upload_user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

**字段说明**：
| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 文档ID |
| title | VARCHAR(255) | NOT NULL | 文档标题 |
| description | TEXT | | 文档描述 |
| file_name | VARCHAR(255) | NOT NULL | 原始文件名 |
| file_path | VARCHAR(500) | NOT NULL | 服务器存储路径 |
| file_size | INTEGER | NOT NULL | 文件大小（字节） |
| mime_type | VARCHAR(100) | NOT NULL | 文件MIME类型 |
| upload_user_id | INTEGER | NOT NULL, FOREIGN KEY | 上传用户ID |
| is_public | BOOLEAN | DEFAULT 0 | 是否公开（0:私有, 1:公开） |
| tags | TEXT | | 标签（逗号分隔） |
| download_count | INTEGER | DEFAULT 0 | 下载次数 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 上传时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
```sql
CREATE INDEX idx_documents_title ON documents(title);
CREATE INDEX idx_documents_upload_user ON documents(upload_user_id);
CREATE INDEX idx_documents_public ON documents(is_public);
CREATE INDEX idx_documents_created_at ON documents(created_at);
CREATE INDEX idx_documents_tags ON documents(tags);
```

### 3. 下载记录表（download_logs）

**表结构**：
```sql
CREATE TABLE download_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    document_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    ip_address VARCHAR(45),
    user_agent TEXT,
    downloaded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

**字段说明**：
| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 记录ID |
| document_id | INTEGER | NOT NULL, FOREIGN KEY | 文档ID |
| user_id | INTEGER | NOT NULL, FOREIGN KEY | 下载用户ID |
| ip_address | VARCHAR(45) | | IP地址 |
| user_agent | TEXT | | 浏览器信息 |
| downloaded_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 下载时间 |

**索引设计**：
```sql
CREATE INDEX idx_download_logs_document ON download_logs(document_id);
CREATE INDEX idx_download_logs_user ON download_logs(user_id);
CREATE INDEX idx_download_logs_date ON download_logs(downloaded_at);
```

### 4. 搜索历史表（search_logs）

**表结构**：
```sql
CREATE TABLE search_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    keyword VARCHAR(255),
    tags VARCHAR(500),
    result_count INTEGER DEFAULT 0,
    searched_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

**字段说明**：
| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 记录ID |
| user_id | INTEGER | NOT NULL, FOREIGN KEY | 搜索用户ID |
| keyword | VARCHAR(255) | | 搜索关键词 |
| tags | VARCHAR(500) | | 搜索标签 |
| result_count | INTEGER | DEFAULT 0 | 搜索结果数量 |
| searched_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 搜索时间 |

**索引设计**：
```sql
CREATE INDEX idx_search_logs_user ON search_logs(user_id);
CREATE INDEX idx_search_logs_keyword ON search_logs(keyword);
CREATE INDEX idx_search_logs_date ON search_logs(searched_at);
```

## 数据库初始化脚本

```sql
-- 创建数据库文件和表结构
-- 文件路径: /database/init.sql

-- 开启外键约束
PRAGMA foreign_keys = ON;

-- 创建用户表
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) DEFAULT 'user' CHECK(role IN ('admin', 'user')),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 创建文档表
CREATE TABLE IF NOT EXISTS documents (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INTEGER NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    upload_user_id INTEGER NOT NULL,
    is_public BOOLEAN DEFAULT 0,
    tags TEXT,
    download_count INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (upload_user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 创建下载记录表
CREATE TABLE IF NOT EXISTS download_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    document_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    ip_address VARCHAR(45),
    user_agent TEXT,
    downloaded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 创建搜索记录表
CREATE TABLE IF NOT EXISTS search_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    keyword VARCHAR(255),
    tags VARCHAR(500),
    result_count INTEGER DEFAULT 0,
    searched_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
CREATE INDEX IF NOT EXISTS idx_users_role ON users(role);

CREATE INDEX IF NOT EXISTS idx_documents_title ON documents(title);
CREATE INDEX IF NOT EXISTS idx_documents_upload_user ON documents(upload_user_id);
CREATE INDEX IF NOT EXISTS idx_documents_public ON documents(is_public);
CREATE INDEX IF NOT EXISTS idx_documents_created_at ON documents(created_at);
CREATE INDEX IF NOT EXISTS idx_documents_tags ON documents(tags);

CREATE INDEX IF NOT EXISTS idx_download_logs_document ON download_logs(document_id);
CREATE INDEX IF NOT EXISTS idx_download_logs_user ON download_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_download_logs_date ON download_logs(downloaded_at);

CREATE INDEX IF NOT EXISTS idx_search_logs_user ON search_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_search_logs_keyword ON search_logs(keyword);
CREATE INDEX IF NOT EXISTS idx_search_logs_date ON search_logs(searched_at);

-- 创建触发器：自动更新updated_at字段
CREATE TRIGGER IF NOT EXISTS update_users_timestamp
AFTER UPDATE ON users
BEGIN
    UPDATE users SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS update_documents_timestamp
AFTER UPDATE ON documents
BEGIN
    UPDATE documents SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;

-- 插入默认管理员账户
INSERT OR IGNORE INTO users (username, email, password_hash, role)
VALUES ('admin', 'admin@example.com', '$2b$10$YourHashedPasswordHere', 'admin');
```

## 常用SQL查询示例

### 用户相关查询
```sql
-- 查询用户信息（登录验证）
SELECT id, username, email, password_hash, role
FROM users
WHERE email = ?;

-- 创建新用户
INSERT INTO users (username, email, password_hash, role)
VALUES (?, ?, ?, ?);

-- 获取用户列表（管理员）
SELECT id, username, email, role, created_at
FROM users
ORDER BY created_at DESC
LIMIT ? OFFSET ?;
```

### 文档相关查询
```sql
-- 获取文档列表（带权限过滤）
SELECT d.*, u.username as upload_username
FROM documents d
JOIN users u ON d.upload_user_id = u.id
WHERE d.is_public = 1 OR d.upload_user_id = ?
ORDER BY d.created_at DESC
LIMIT ? OFFSET ?;

-- 搜索文档（按标题和标签）
SELECT d.*, u.username as upload_username
FROM documents d
JOIN users u ON d.upload_user_id = u.id
WHERE (d.title LIKE ? OR d.tags LIKE ?)
  AND (d.is_public = 1 OR d.upload_user_id = ?)
ORDER BY d.created_at DESC;

-- 获取用户上传的文档
SELECT * FROM documents
WHERE upload_user_id = ?
ORDER BY created_at DESC;

-- 更新文档下载次数
UPDATE documents
SET download_count = download_count + 1
WHERE id = ?;

-- 删除文档
DELETE FROM documents WHERE id = ? AND upload_user_id = ?;
```

### 统计查询
```sql
-- 获取文档统计信息
SELECT
    COUNT(*) as total_documents,
    COUNT(DISTINCT upload_user_id) as total_uploaders,
    SUM(file_size) as total_size,
    SUM(download_count) as total_downloads
FROM documents;

-- 获取热门文档（按下载量）
SELECT id, title, download_count, created_at
FROM documents
WHERE is_public = 1
ORDER BY download_count DESC
LIMIT 10;

-- 获取热门标签
SELECT tags, COUNT(*) as tag_count
FROM (
    SELECT TRIM(value) as tags
    FROM documents, json_each('["' || REPLACE(tags, ',', '","') || '"]')
    WHERE tags IS NOT NULL
)
GROUP BY tags
ORDER BY tag_count DESC
LIMIT 20;

-- 获取用户活跃度统计
SELECT
    u.username,
    COUNT(d.id) as document_count,
    SUM(d.download_count) as total_downloads
FROM users u
LEFT JOIN documents d ON u.id = d.upload_user_id
GROUP BY u.id
ORDER BY document_count DESC;
```

## 数据库优化策略

### 1. 查询优化
- 使用参数化查询防止SQL注入
- 合理使用索引提高查询效率
- 避免全表扫描
- 使用EXPLAIN分析查询计划

### 2. 事务处理
```javascript
// 事务示例
db.serialize(() => {
    db.run("BEGIN TRANSACTION");
    try {
        // 执行多个数据库操作
        db.run("INSERT INTO documents ...");
        db.run("UPDATE users ...");
        db.run("COMMIT");
    } catch (error) {
        db.run("ROLLBACK");
        throw error;
    }
});
```

### 3. 连接池管理
```javascript
// 连接池配置
const pool = {
    max: 5,        // 最大连接数
    min: 0,        // 最小连接数
    idle: 10000    // 连接空闲超时
};
```

### 4. 定期维护
```sql
-- 定期执行数据库优化
VACUUM;        -- 清理空间
ANALYZE;       -- 更新统计信息
REINDEX;       -- 重建索引
```

## 数据备份策略

### 自动备份脚本
```bash
#!/bin/bash
# 每日自动备份数据库

BACKUP_DIR="/backups/database"
DB_FILE="/database/knowledge_base.db"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/knowledge_base_$DATE.db"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
cp $DB_FILE $BACKUP_FILE

# 压缩备份文件
gzip $BACKUP_FILE

# 删除7天前的备份
find $BACKUP_DIR -name "*.db.gz" -mtime +7 -delete

echo "Backup completed: ${BACKUP_FILE}.gz"
```

### 恢复策略
```bash
#!/bin/bash
# 数据库恢复脚本

BACKUP_FILE=$1
DB_FILE="/database/knowledge_base.db"

# 解压备份文件
gunzip -c $BACKUP_FILE > /tmp/restore.db

# 停止应用服务
pm2 stop knowledge-base

# 备份当前数据库
mv $DB_FILE "${DB_FILE}.old"

# 恢复数据库
mv /tmp/restore.db $DB_FILE

# 重启应用服务
pm2 start knowledge-base

echo "Database restored from: $BACKUP_FILE"
```

## 数据迁移

### 迁移到MySQL/PostgreSQL
如果未来需要迁移到其他数据库，可以使用以下策略：

1. **导出SQLite数据**
```bash
sqlite3 knowledge_base.db .dump > export.sql
```

2. **转换SQL语法**
- 修改数据类型（INTEGER → INT）
- 修改自增语法（AUTOINCREMENT → AUTO_INCREMENT）
- 调整日期函数

3. **导入到新数据库**
```bash
mysql -u root -p knowledge_base < export_mysql.sql
```

---
**更新时间**：2025-09-20
**文档版本**：v1.0